import{z as y,A as S,q as Se,r as l,j as e,t as h}from"./index-_T_dclBo.js";import{C as p,a as f,b as we,c as Ce,e as Ae}from"./card-mM-adsMl.js";import{D as se,a as te,b as ae,c as ne,d as ie}from"./dialog-R0K7NxxJ.js";import{I as q}from"./input-BvLdwGAG.js";import{L as j}from"./label-DvinGlq6.js";import{c as w,d as C,e as A,f as I,g,b as U,B as x}from"./ownerService-CJxlrD2e.js";import{E as re,S as W}from"./EmptyState-CZE-0j11.js";import{u as Ie,E as Pe,a as Oe,P as ke,C as Ee}from"./useDebouncedValue-tealXdGx.js";import{u as Te,a as T,C as le}from"./Dashboard-vSO5UD5A.js";import{u as De}from"./useStaff-DIArrfxW.js";import{u as _e}from"./useServices-6dh7S5Ff.js";import{u as Me}from"./useClients-sGFMukDF.js";import{C as ce}from"./clock-Bb3qLlbr.js";import{C as de}from"./circle-check-BWQBntIy.js";import{S as Fe}from"./search-1uIckXng.js";import{T as Le}from"./trash-2-DIkBWH60.js";import"./index-BHur5ELe.js";import"./createLucideIcon-vxqge8nX.js";const Ve=(t,c)=>{const i=t.data?.[c]??[];return{items:i,pagination:t.pagination??{page:1,limit:i.length,total:i.length,totalPages:1,hasNext:!1,hasPrev:!1}}},P={async list(t){const c=await y.get(S.OWNER.APPOINTMENTS,{params:{...t,branchId:t.branchId||void 0}});return Ve(c,"appointments")},async create(t){return(await y.post(S.OWNER.APPOINTMENTS,t)).data?.appointment},async update(t,c){return(await y.patch(`${S.OWNER.APPOINTMENTS}/${t}`,c)).data?.appointment},async remove(t){await y.delete(`${S.OWNER.APPOINTMENTS}/${t}`)},async cancel(t,c){return(await y.post(`${S.OWNER.APPOINTMENTS}/${t}/cancel`,{reason:c})).data?.appointment}},Re=t=>["owner-appointments",t.branchId,t.search,t.status,t.from,t.to,t.page,t.limit];function ze(t){return Te({queryKey:Re(t),queryFn:()=>P.list(t),enabled:!!t.branchId,keepPreviousData:!0})}function qe(t){const c=Se(),i=()=>c.invalidateQueries({queryKey:["owner-appointments",t],exact:!1}),D=T({mutationFn:d=>P.create({...d,branchId:d.branchId||t||void 0}),onSuccess:i}),O=T({mutationFn:({id:d,data:v})=>P.update(d,v),onSuccess:i}),k=T({mutationFn:d=>P.remove(d),onSuccess:i}),_=T({mutationFn:({id:d,reason:v})=>P.cancel(d,v),onSuccess:i});return{create:D,update:O,remove:k,cancel:_}}const oe={clientId:"",staffId:"",serviceIds:[],startAt:new Date().toISOString().slice(0,16),notes:"",status:"confirmed"},me=["pending","confirmed","completed","cancelled"];function rs({activeBranchId:t}){const[c,i]=l.useState(!1),[D,O]=l.useState(!1),[k,_]=l.useState(""),[d,v]=l.useState(),[xe,M]=l.useState(1),[o,m]=l.useState(oe),[n,F]=l.useState(null),[N,$]=l.useState(""),H=Ie(k),he=6;l.useEffect(()=>{M(1)},[H,d,t]);const{data:K,isLoading:ue}=ze({branchId:t,search:H,status:d,page:xe,limit:he}),b=K?.items??[],u=K?.pagination,{data:L}=De({branchId:t,page:1,limit:100}),{data:V}=_e({branchId:t,page:1,limit:100}),{data:R}=Me({branchId:t,page:1,limit:100}),{create:Q,update:G,remove:z,cancel:J}=qe(t),X=Q.isPending||G.isPending||z.isPending,Y=()=>{F(null),m({...oe,startAt:new Date().toISOString().slice(0,16)}),i(!0)},pe=s=>{F(s),m({clientId:typeof s.client=="string"?s.client:s.client?._id||"",staffId:typeof s.staff=="string"?s.staff:s.staff?._id||"",serviceIds:s.services?.map(a=>typeof a.service=="string"?a.service:a.service?._id).filter(Boolean)||[],startAt:s.startAt?.slice(0,16),notes:s.notes||"",status:s.status||"pending"}),i(!0)},fe=s=>{F(s),O(!0)},je=async()=>{if(!o.clientId||!o.staffId||o.serviceIds.length===0){h.error("Client, staff, and at least one service are required");return}try{n?(await G.mutateAsync({id:n._id,data:o}),h.success("Appointment updated")):(await Q.mutateAsync({...o,branchId:t||void 0}),h.success("Appointment created")),i(!1)}catch(s){h.error(s?.message||"Unable to save appointment")}},ge=async s=>{try{await z.mutateAsync(s),h.success("Appointment deleted")}catch(a){h.error(a?.message||"Unable to delete appointment")}},ve=async s=>{try{await J.mutateAsync({id:s}),h.success("Appointment cancelled")}catch(a){h.error(a?.message||"Unable to cancel appointment")}},Ne=()=>{N&&(m(s=>({...s,serviceIds:s.serviceIds.includes(N)?s.serviceIds:[...s.serviceIds,N]})),$(""))},be=s=>{m(a=>({...a,serviceIds:a.serviceIds.filter(r=>r!==s)}))},E=l.useMemo(()=>{const s={total:u?.total??b.length,pending:0,confirmed:0,completed:0};return b.forEach(a=>{const r=a.status||"pending";r==="pending"&&(s.pending+=1),r==="confirmed"&&(s.confirmed+=1),r==="completed"&&(s.completed+=1)}),s},[b,u?.total]),ye=l.useMemo(()=>(V?.items??[]).reduce((a,r)=>(a[r._id]=r,a),{}),[V]),Z=l.useMemo(()=>(L?.items??[]).reduce((a,r)=>(a[r._id]=r,a),{}),[L]),B=l.useMemo(()=>(R?.items??[]).reduce((a,r)=>(a[r._id]=r,a),{}),[R]);return t?e.jsxs("div",{className:"space-y-6",children:[e.jsx(Pe,{title:"Appointments",description:"Review bookings for the selected branch.",onCreate:Y,createLabel:"Create Appointment",isCreateDisabled:!t}),e.jsxs("div",{className:"grid gap-4 sm:grid-cols-2 lg:grid-cols-4",children:[e.jsx(p,{className:"border-l-4 border-l-purple-500 hover:shadow-lg transition-shadow",children:e.jsx(f,{className:"p-4",children:e.jsxs("div",{className:"flex items-start justify-between gap-2",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-sm text-muted-foreground mb-1",children:"Total Appointments"}),e.jsx("div",{className:"text-2xl text-foreground mb-1",children:E.total})]}),e.jsx("div",{className:"shrink-0 w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center",children:e.jsx(le,{className:"w-5 h-5 text-purple-600"})})]})})}),e.jsx(p,{className:"border-l-4 border-l-amber-500 hover:shadow-lg transition-shadow",children:e.jsx(f,{className:"p-4",children:e.jsxs("div",{className:"flex items-start justify-between gap-2",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-sm text-muted-foreground mb-1",children:"Pending"}),e.jsx("div",{className:"text-2xl text-foreground mb-1",children:E.pending})]}),e.jsx("div",{className:"shrink-0 w-10 h-10 bg-amber-100 rounded-full flex items-center justify-center",children:e.jsx(ce,{className:"w-5 h-5 text-amber-600"})})]})})}),e.jsx(p,{className:"border-l-4 border-l-blue-500 hover:shadow-lg transition-shadow",children:e.jsx(f,{className:"p-4",children:e.jsxs("div",{className:"flex items-start justify-between gap-2",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-sm text-muted-foreground mb-1",children:"Confirmed"}),e.jsx("div",{className:"text-2xl text-foreground mb-1",children:E.confirmed})]}),e.jsx("div",{className:"shrink-0 w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center",children:e.jsx(de,{className:"w-5 h-5 text-blue-600"})})]})})}),e.jsx(p,{className:"border-l-4 border-l-green-500 hover:shadow-lg transition-shadow",children:e.jsx(f,{className:"p-4",children:e.jsxs("div",{className:"flex items-start justify-between gap-2",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-sm text-muted-foreground mb-1",children:"Completed"}),e.jsx("div",{className:"text-2xl text-foreground mb-1",children:E.completed})]}),e.jsx("div",{className:"shrink-0 w-10 h-10 bg-green-100 rounded-full flex items-center justify-center",children:e.jsx(de,{className:"w-5 h-5 text-green-600"})})]})})})]}),e.jsx(p,{className:"bg-card border-border",children:e.jsx(f,{className:"pt-6",children:e.jsxs("div",{className:"flex flex-col md:flex-row gap-4",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(Fe,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-muted-foreground"}),e.jsx(q,{placeholder:"Search appointments...",value:k,onChange:s=>_(s.target.value),className:"pl-10 bg-input-background border-border"})]}),e.jsxs(w,{value:d||"all",onValueChange:s=>v(s==="all"?void 0:s),children:[e.jsx(C,{className:"w-full md:w-48 bg-input-background border-border",children:e.jsx(A,{placeholder:"All statuses"})}),e.jsxs(I,{children:[e.jsx(g,{value:"all",children:"All"}),me.map(s=>e.jsx(g,{value:s,children:s},s))]})]})]})})}),ue?e.jsx("div",{className:"grid gap-4 md:grid-cols-2",children:Array.from({length:4}).map((s,a)=>e.jsx(p,{children:e.jsxs(f,{className:"space-y-3 py-6",children:[e.jsx(W,{className:"h-6 w-48"}),e.jsx(W,{className:"h-4 w-32"}),e.jsx(W,{className:"h-4 w-64"})]})},a))}):b.length===0?e.jsx(re,{title:"No appointments yet",description:"Create an appointment to get started.",actionLabel:"Create appointment",onAction:Y}):e.jsx("div",{className:"grid gap-4 md:grid-cols-2",children:b.map(s=>{const a=typeof s.client=="string"?B[s.client]:s.client,r=typeof s.staff=="string"?Z[s.staff]:s.staff;return e.jsxs(p,{children:[e.jsxs(we,{className:"flex flex-row items-center justify-between space-y-0",children:[e.jsx(Ce,{children:a?.fullName||"Client"}),e.jsx(U,{children:s.status})]}),e.jsxs(f,{className:"space-y-3 text-sm text-muted-foreground",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(le,{className:"h-4 w-4"}),new Date(s.startAt).toLocaleString()]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ce,{className:"h-4 w-4"}),Math.round(s.duration??0)," mins"]}),e.jsxs("div",{children:["Staff: ",e.jsx("span",{className:"text-foreground",children:r?.name})]}),e.jsx("div",{className:"flex flex-wrap gap-1",children:s.services?.map(ee=>e.jsx(U,{variant:"secondary",children:ee.name},ee.name))})]}),e.jsxs(Ae,{className:"flex items-center justify-end gap-2",children:[s.status!=="cancelled"&&e.jsx(x,{size:"sm",variant:"outline",onClick:()=>ve(s._id),disabled:J.isPending,children:"Cancel"}),e.jsx(x,{size:"icon",variant:"ghost",onClick:()=>fe(s),children:e.jsx(Oe,{className:"h-4 w-4"})}),e.jsx(x,{size:"icon",variant:"ghost",onClick:()=>pe(s),children:e.jsx(ke,{className:"h-4 w-4"})}),e.jsx(Ee,{title:"Delete appointment",description:"This booking will be removed from the schedule.",onConfirm:()=>ge(s._id),trigger:e.jsx(x,{size:"icon",variant:"ghost",children:e.jsx(Le,{className:"h-4 w-4"})}),disabled:z.isPending})]})]},s._id)})}),u&&e.jsxs("div",{className:"flex items-center justify-between text-sm text-muted-foreground",children:[e.jsxs("div",{children:["Page ",u.page," of ",u.totalPages]}),e.jsxs("div",{className:"space-x-2",children:[e.jsx(x,{variant:"outline",size:"sm",onClick:()=>M(s=>Math.max(s-1,1)),disabled:!u.hasPrev,children:"Previous"}),e.jsx(x,{variant:"outline",size:"sm",onClick:()=>M(s=>s+1),disabled:!u.hasNext,children:"Next"})]})]}),e.jsx(se,{open:c,onOpenChange:i,children:e.jsxs(te,{className:"max-w-2xl",children:[e.jsxs(ae,{children:[e.jsx(ne,{children:n?"Edit Appointment":"New Appointment"}),e.jsx(ie,{className:"sr-only",children:n?"Update appointment details.":"Enter appointment details."})]}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-2",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(j,{children:"Client"}),e.jsxs(w,{value:o.clientId,onValueChange:s=>m(a=>({...a,clientId:s})),children:[e.jsx(C,{children:e.jsx(A,{placeholder:"Select client"})}),e.jsx(I,{children:(R?.items??[]).map(s=>e.jsx(g,{value:s._id,children:s.fullName},s._id))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(j,{children:"Staff"}),e.jsxs(w,{value:o.staffId,onValueChange:s=>m(a=>({...a,staffId:s})),children:[e.jsx(C,{children:e.jsx(A,{placeholder:"Select staff"})}),e.jsx(I,{children:(L?.items??[]).map(s=>e.jsx(g,{value:s._id,children:s.name},s._id))})]})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"grid gap-4 md:grid-cols-2",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(j,{children:"Start time"}),e.jsx(q,{type:"datetime-local",value:o.startAt,onChange:s=>m(a=>({...a,startAt:s.target.value}))})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(j,{children:"Status"}),e.jsxs(w,{value:o.status,onValueChange:s=>m(a=>({...a,status:s})),children:[e.jsx(C,{children:e.jsx(A,{})}),e.jsx(I,{children:me.map(s=>e.jsx(g,{value:s,children:s},s))})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(j,{children:"Services"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(w,{value:N,onValueChange:$,children:[e.jsx(C,{children:e.jsx(A,{placeholder:"Select service"})}),e.jsx(I,{children:(V?.items??[]).map(s=>e.jsx(g,{value:s._id,children:s.name},s._id))})]}),e.jsx(x,{variant:"outline",onClick:Ne,disabled:!N,children:"Add"})]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:o.serviceIds.map(s=>e.jsxs(U,{variant:"secondary",className:"gap-1",children:[ye[s]?.name||"Service",e.jsx("button",{type:"button",className:"ml-1 text-xs",onClick:()=>be(s),children:"✕"})]},s))})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(j,{children:"Notes"}),e.jsx(q,{value:o.notes,onChange:s=>m(a=>({...a,notes:s.target.value}))})]})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(x,{variant:"outline",onClick:()=>i(!1),disabled:X,children:"Cancel"}),e.jsx(x,{onClick:je,disabled:X,children:"Save"})]})]})}),e.jsx(se,{open:D,onOpenChange:O,children:e.jsxs(te,{children:[e.jsxs(ae,{children:[e.jsx(ne,{children:"Appointment Details"}),e.jsx(ie,{className:"sr-only",children:"Review appointment details."})]}),e.jsxs("div",{className:"space-y-2 text-sm text-muted-foreground",children:[e.jsxs("div",{children:["Client:"," ",n?.client&&(typeof n.client=="string"?B[n.client]?.fullName:n.client.fullName)]}),e.jsxs("div",{children:["Staff:"," ",n?.staff&&(typeof n.staff=="string"?Z[n.staff]?.name:n.staff.name)]}),e.jsxs("div",{children:["When:"," ",n?new Date(n.startAt).toLocaleString():"—"]}),e.jsxs("div",{children:["Services:"," ",n?.services?.map(s=>s.name).join(", ")||"—"]}),e.jsxs("div",{children:["Status: ",n?.status]}),e.jsxs("div",{children:["Notes: ",n?.notes||"—"]})]})]})})]}):e.jsx(re,{title:"Select a branch",description:"Choose a branch to manage appointments."})}export{rs as default};
