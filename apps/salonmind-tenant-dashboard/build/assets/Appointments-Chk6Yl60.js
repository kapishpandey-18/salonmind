import{z as v,A as N,q as ge,r as o,j as e,t as h}from"./index-DEsDXUSK.js";import{C as Y,d as Z,a as ve,b as Ne,e as Se}from"./card-CSfxeEk0.js";import{D as B,a as ee,b as se,c as te}from"./dialog-DM_WnBAe.js";import{I as ae}from"./input-fORRFi0u.js";import{L as x}from"./label-CZBKjXX6.js";import{B as u}from"./SalonMindLogo-BdYlaItP.js";import{a as S,b as y,c as C,d as A,e as p,B as L}from"./ownerService-B2O02PeP.js";import{u as ye,E as ne,a as Ce,S as V,b as Ae,P as be,C as Ie}from"./useDebouncedValue-zGanXLWo.js";import{u as we,a as P,C as Pe}from"./Dashboard-Bh94dQr3.js";import{u as Oe}from"./useStaff-DAHatu7M.js";import{u as Ee}from"./useServices-CMmBhyjA.js";import{u as Te}from"./useClients-BcmQR8O5.js";import{C as _e}from"./clock-CLJWZEMI.js";import{T as De}from"./trash-2-B2_TkTN0.js";import"./index-prrkowPK.js";import"./search-BXv_aqr2.js";const ke=(t,c)=>{const n=t.data?.[c]??[];return{items:n,pagination:t.pagination??{page:1,limit:n.length,total:n.length,totalPages:1,hasNext:!1,hasPrev:!1}}},b={async list(t){const c=await v.get(N.OWNER.APPOINTMENTS,{params:{...t,branchId:t.branchId||void 0}});return ke(c,"appointments")},async create(t){return(await v.post(N.OWNER.APPOINTMENTS,t)).data?.appointment},async update(t,c){return(await v.patch(`${N.OWNER.APPOINTMENTS}/${t}`,c)).data?.appointment},async remove(t){await v.delete(`${N.OWNER.APPOINTMENTS}/${t}`)},async cancel(t,c){return(await v.post(`${N.OWNER.APPOINTMENTS}/${t}/cancel`,{reason:c})).data?.appointment}},Me=t=>["owner-appointments",t.branchId,t.search,t.status,t.from,t.to,t.page,t.limit];function Fe(t){return we({queryKey:Me(t),queryFn:()=>b.list(t),enabled:!!t.branchId,keepPreviousData:!0})}function Le(t){const c=ge(),n=()=>c.invalidateQueries({queryKey:["owner-appointments",t],exact:!1}),O=P({mutationFn:r=>b.create({...r,branchId:r.branchId||t||void 0}),onSuccess:n}),I=P({mutationFn:({id:r,data:f})=>b.update(r,f),onSuccess:n}),w=P({mutationFn:r=>b.remove(r),onSuccess:n}),E=P({mutationFn:({id:r,reason:f})=>b.cancel(r,f),onSuccess:n});return{create:O,update:I,remove:w,cancel:E}}const ie={clientId:"",staffId:"",serviceIds:[],startAt:new Date().toISOString().slice(0,16),notes:"",status:"confirmed"},ce=["pending","confirmed","completed","cancelled"];function es({activeBranchId:t}){const[c,n]=o.useState(!1),[O,I]=o.useState(!1),[w,E]=o.useState(""),[r,f]=o.useState(),[re,T]=o.useState(1),[d,m]=o.useState(ie),[i,_]=o.useState(null),[j,R]=o.useState(""),z=ye(w),le=6;o.useEffect(()=>{T(1)},[z,r,t]);const{data:q,isLoading:oe}=Fe({branchId:t,search:z,status:r,page:re,limit:le}),W=q?.items??[],g=q?.pagination,{data:D}=Oe({branchId:t,page:1,limit:100}),{data:k}=Ee({branchId:t,page:1,limit:100}),{data:M}=Te({branchId:t,page:1,limit:100}),{create:$,update:U,remove:F,cancel:H}=Le(t),K=$.isPending||U.isPending||F.isPending,Q=()=>{_(null),m({...ie,startAt:new Date().toISOString().slice(0,16)}),n(!0)},de=s=>{_(s),m({clientId:typeof s.client=="string"?s.client:s.client?._id||"",staffId:typeof s.staff=="string"?s.staff:s.staff?._id||"",serviceIds:s.services?.map(a=>typeof a.service=="string"?a.service:a.service?._id).filter(Boolean)||[],startAt:s.startAt?.slice(0,16),notes:s.notes||"",status:s.status||"pending"}),n(!0)},me=s=>{_(s),I(!0)},ue=async()=>{if(!d.clientId||!d.staffId||d.serviceIds.length===0){h.error("Client, staff, and at least one service are required");return}try{i?(await U.mutateAsync({id:i._id,data:d}),h.success("Appointment updated")):(await $.mutateAsync({...d,branchId:t||void 0}),h.success("Appointment created")),n(!1)}catch(s){h.error(s?.message||"Unable to save appointment")}},he=async s=>{try{await F.mutateAsync(s),h.success("Appointment deleted")}catch(a){h.error(a?.message||"Unable to delete appointment")}},xe=async s=>{try{await H.mutateAsync({id:s}),h.success("Appointment cancelled")}catch(a){h.error(a?.message||"Unable to cancel appointment")}},pe=()=>{j&&(m(s=>({...s,serviceIds:s.serviceIds.includes(j)?s.serviceIds:[...s.serviceIds,j]})),R(""))},fe=s=>{m(a=>({...a,serviceIds:a.serviceIds.filter(l=>l!==s)}))},je=o.useMemo(()=>(k?.items??[]).reduce((a,l)=>(a[l._id]=l,a),{}),[k]),G=o.useMemo(()=>(D?.items??[]).reduce((a,l)=>(a[l._id]=l,a),{}),[D]),J=o.useMemo(()=>(M?.items??[]).reduce((a,l)=>(a[l._id]=l,a),{}),[M]);return t?e.jsxs("div",{className:"space-y-6",children:[e.jsx(Ce,{title:"Appointments",description:"Review bookings for the selected branch.",searchValue:w,onSearchChange:E,onCreate:Q,createLabel:"Create Appointment",isCreateDisabled:!t}),e.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[e.jsx(x,{className:"text-sm",children:"Status"}),e.jsxs(S,{value:r||"all",onValueChange:s=>f(s==="all"?void 0:s),children:[e.jsx(y,{className:"w-40",children:e.jsx(C,{placeholder:"All statuses"})}),e.jsxs(A,{children:[e.jsx(p,{value:"all",children:"All"}),ce.map(s=>e.jsx(p,{value:s,children:s},s))]})]})]}),oe?e.jsx("div",{className:"grid gap-4 md:grid-cols-2",children:Array.from({length:4}).map((s,a)=>e.jsx(Y,{children:e.jsxs(Z,{className:"space-y-3 py-6",children:[e.jsx(V,{className:"h-6 w-48"}),e.jsx(V,{className:"h-4 w-32"}),e.jsx(V,{className:"h-4 w-64"})]})},a))}):W.length===0?e.jsx(ne,{title:"No appointments yet",description:"Create an appointment to get started.",actionLabel:"Create appointment",onAction:Q}):e.jsx("div",{className:"grid gap-4 md:grid-cols-2",children:W.map(s=>{const a=typeof s.client=="string"?J[s.client]:s.client,l=typeof s.staff=="string"?G[s.staff]:s.staff;return e.jsxs(Y,{children:[e.jsxs(ve,{className:"flex flex-row items-center justify-between space-y-0",children:[e.jsx(Ne,{children:a?.fullName||"Client"}),e.jsx(L,{children:s.status})]}),e.jsxs(Z,{className:"space-y-3 text-sm text-muted-foreground",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Pe,{className:"h-4 w-4"}),new Date(s.startAt).toLocaleString()]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(_e,{className:"h-4 w-4"}),Math.round(s.duration??0)," mins"]}),e.jsxs("div",{children:["Staff: ",e.jsx("span",{className:"text-foreground",children:l?.name})]}),e.jsx("div",{className:"flex flex-wrap gap-1",children:s.services?.map(X=>e.jsx(L,{variant:"secondary",children:X.name},X.name))})]}),e.jsxs(Se,{className:"flex items-center justify-end gap-2",children:[s.status!=="cancelled"&&e.jsx(u,{size:"sm",variant:"outline",onClick:()=>xe(s._id),disabled:H.isPending,children:"Cancel"}),e.jsx(u,{size:"icon",variant:"ghost",onClick:()=>me(s),children:e.jsx(Ae,{className:"h-4 w-4"})}),e.jsx(u,{size:"icon",variant:"ghost",onClick:()=>de(s),children:e.jsx(be,{className:"h-4 w-4"})}),e.jsx(Ie,{title:"Delete appointment",description:"This booking will be removed from the schedule.",onConfirm:()=>he(s._id),trigger:e.jsx(u,{size:"icon",variant:"ghost",children:e.jsx(De,{className:"h-4 w-4"})}),disabled:F.isPending})]})]},s._id)})}),g&&e.jsxs("div",{className:"flex items-center justify-between text-sm text-muted-foreground",children:[e.jsxs("div",{children:["Page ",g.page," of ",g.totalPages]}),e.jsxs("div",{className:"space-x-2",children:[e.jsx(u,{variant:"outline",size:"sm",onClick:()=>T(s=>Math.max(s-1,1)),disabled:!g.hasPrev,children:"Previous"}),e.jsx(u,{variant:"outline",size:"sm",onClick:()=>T(s=>s+1),disabled:!g.hasNext,children:"Next"})]})]}),e.jsx(B,{open:c,onOpenChange:n,children:e.jsxs(ee,{className:"max-w-2xl",children:[e.jsx(se,{children:e.jsx(te,{children:i?"Edit Appointment":"New Appointment"})}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-2",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{children:"Client"}),e.jsxs(S,{value:d.clientId,onValueChange:s=>m(a=>({...a,clientId:s})),children:[e.jsx(y,{children:e.jsx(C,{placeholder:"Select client"})}),e.jsx(A,{children:(M?.items??[]).map(s=>e.jsx(p,{value:s._id,children:s.fullName},s._id))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{children:"Staff"}),e.jsxs(S,{value:d.staffId,onValueChange:s=>m(a=>({...a,staffId:s})),children:[e.jsx(y,{children:e.jsx(C,{placeholder:"Select staff"})}),e.jsx(A,{children:(D?.items??[]).map(s=>e.jsx(p,{value:s._id,children:s.name},s._id))})]})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"grid gap-4 md:grid-cols-2",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{children:"Start time"}),e.jsx(ae,{type:"datetime-local",value:d.startAt,onChange:s=>m(a=>({...a,startAt:s.target.value}))})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{children:"Status"}),e.jsxs(S,{value:d.status,onValueChange:s=>m(a=>({...a,status:s})),children:[e.jsx(y,{children:e.jsx(C,{})}),e.jsx(A,{children:ce.map(s=>e.jsx(p,{value:s,children:s},s))})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{children:"Services"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(S,{value:j,onValueChange:R,children:[e.jsx(y,{children:e.jsx(C,{placeholder:"Select service"})}),e.jsx(A,{children:(k?.items??[]).map(s=>e.jsx(p,{value:s._id,children:s.name},s._id))})]}),e.jsx(u,{variant:"outline",onClick:pe,disabled:!j,children:"Add"})]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:d.serviceIds.map(s=>e.jsxs(L,{variant:"secondary",className:"gap-1",children:[je[s]?.name||"Service",e.jsx("button",{type:"button",className:"ml-1 text-xs",onClick:()=>fe(s),children:"✕"})]},s))})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{children:"Notes"}),e.jsx(ae,{value:d.notes,onChange:s=>m(a=>({...a,notes:s.target.value}))})]})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(u,{variant:"outline",onClick:()=>n(!1),disabled:K,children:"Cancel"}),e.jsx(u,{onClick:ue,disabled:K,children:"Save"})]})]})}),e.jsx(B,{open:O,onOpenChange:I,children:e.jsxs(ee,{children:[e.jsx(se,{children:e.jsx(te,{children:"Appointment Details"})}),e.jsxs("div",{className:"space-y-2 text-sm text-muted-foreground",children:[e.jsxs("div",{children:["Client:"," ",i?.client&&(typeof i.client=="string"?J[i.client]?.fullName:i.client.fullName)]}),e.jsxs("div",{children:["Staff:"," ",i?.staff&&(typeof i.staff=="string"?G[i.staff]?.name:i.staff.name)]}),e.jsxs("div",{children:["When:"," ",i?new Date(i.startAt).toLocaleString():"—"]}),e.jsxs("div",{children:["Services:"," ",i?.services?.map(s=>s.name).join(", ")||"—"]}),e.jsxs("div",{children:["Status: ",i?.status]}),e.jsxs("div",{children:["Notes: ",i?.notes||"—"]})]})]})})]}):e.jsx(ne,{title:"Select a branch",description:"Choose a branch to manage appointments."})}export{es as default};
